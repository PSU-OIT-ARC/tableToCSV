<html>
<head>
	<title>
		File Stuff
	</title>
	
	
	<script src="jquery-1.11.1.js"></script>	
	
	<table class='export1' filename='export.csv'>
		<thead>
			<tr>
				<th>Name:</th>
				<th>Occupation:</th>
				<th>Age:</th>			
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>Bond, James</td>
				<td>Alcoholic</td>
				<td>37</td>
			</tr>
			<tr>
				<td>David "Zeb" Cook</td>
				<td>Dungeon Master</td>
				<td>97</td>
			</tr>
			<tr>
				<td>Mr. Potato Head, Esquire</td>
				<td>"Comedian"</td>
				<td>3</td>
			</tr>
			<tr>
				<td>John Carmack</td>
				<td>Nerd</td>
				<td>45</td>
			</tr>
		</tbody>		
	</table>

	<div id='testing'><a href="">Testing Text.</a></div>

	<a href="#" onclick="export_csv('test.csv', 'export1')">Testing Button</a>
	
</head>
	
<body>	
<script>

	function parse_string_for_csv(input_string) {
		
		// if there are double-quotes or commas in the string
		// we need to escape the quotes and surround the whole thing with quotes
				
		// there might be a slicker way to do this using RegEx, but we'll
		// save that for later, if this proves to be too slow:				
				
		output_string = input_string.replace(/"/g, "\"\"");			// escape quotes
		
		if (input_string.search("[\",]") != -1) {					// enclose in quotes
			output_string = "\"" + output_string + "\""	
		}		
		output_string = output_string;						// always add the trailing comma

		console.debug("Input string: " + input_string);
		console.debug("Output string: " + output_string);

		return output_string;				
	}		

	
	function export_csv() {

		if (arguments.length < 2) return;		// ERROR!
		
		var filename = arguments[0];
		var csvString = '';						// this will store our CSV	
				
		var cellArray = [];
				
		var currentRowIndex = 0;

		var maxColumnCount = 0;
				
		for (var i = 1; i < arguments.length; i++) {

			class_name = arguments[i]
			
			$("." + class_name).each( function() {		
				
				$(this).find("tr").each(function() {
	
					var columnCount = 0;		// should check current row instead, to deal with rowspawn
										
					var currentRow = []
					
					$(this).find("th, td").each(function() {
						currentRow.push(parse_string_for_csv(this.textContent));
						columnCount++;
					});
		
					if (columnCount > maxColumnCount) maxColumnCount = columnCount;
					
					cellArray.push(currentRow);			// should check to see if this row already exists or not
					
					currentRowIndex++;
				});								
			});			
		}

		for (var currentRowIndex = 0; currentRowIndex < cellArray.length; currentRowIndex++) {

			var currentRow = cellArray[currentRowIndex];

			csvString += currentRow.join();
									
			for (var missingColumns = maxColumnCount - currentRow.length; missingColumns > 0; missingColumns - 1) {				
				csvString += ',';
			}
			
			csvString += '\r\n';
		}

		var aFileParts = [csvString];
		
		// turn it into a blob in local storage:
		var oMyBlob = new Blob(aFileParts, {type : 'text/csv'}); // the blob
		
		var url = URL.createObjectURL(oMyBlob);		// get the URL to the blob
		
		// creates the temporary link that will send us to our generated CSV
		// don't use visible: False or hidden: True, or the click event won't work
		var temp_link = $('<a>',{
			text: 'A',
    		title: '',
    		href: url,
    		download: filename
		})		
		temp_link.appendTo('body');

		//temp_link[0].click();		// hack to mack the forced link-click work
	}	
	
</script>


</body>
</html>
