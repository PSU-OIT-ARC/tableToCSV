<html>
<head>
	<title>
		File Stuff
	</title>
	
	
	<script src="jquery-1.11.1.js"></script>	
	
</head>	
<body>	
	<table id='export1' filename='export.csv'>
		<thead>
			<tr>
				<th>Name:</th>
				<th>Occupation:</th>
				<th>Age:</th>			
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>Bond, James</td>
				<td>Alcoholic</td>
				<td>37</td>
			</tr>
			<tr>
				<td>David "Zeb" Cook</td>
				<td>Dungeon Master</td>
				<td>97</td>
			</tr>
			<tr>
				<td>Mr. Potato Head, Esquire</td>
				<td>"Comedian"</td>
				<td>3</td>
			</tr>
			<tr>
				<td>John Carmack</td>
				<td>Nerd</td>
				<td>45</td>
			</tr>
		</tbody>		
	</table>

	<table id='export2' filename='export.csv'>
		<thead>
			<tr>
				<th>Name:</th>
				<th>Occupation:</th>
				<th>Age:</th>		
				<th>Gender:</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>Billy Bob Thorton</td>
				<td>Grizzler</td>
				<td>68</td>
				<td>Male</td>
			</tr>
			<tr>
				<td>What'sit Who'sit</td>
				<td>President</td>
				<td colspan="2">235</td>
			</tr>
			<tr>
				<td>Farrah Fawcett</td>
				<td>Lady With Hair</td>
				<td>60</td>
				<td>Female</td>
			</tr>
			<tr>
				<td colspan="2">Johnny Boy Soprano</td>
				<td>90</td>
				<td>Male</td>								
			</tr>
		</tbody>		
	</table>

	<table id='span_testing' filename='export.csv'>
		<thead>
			<tr>
				<th>Name:</th>
				<th>Occupation:</th>
				<th>Age:</th>		
				<th>Gender:</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td colspan="2" rowspan="2">Billy Bob Thorton</td>
				<td>68</td>
				<td>Male</td>
			</tr>
			<tr>				
				<td>235</td>
				<td>Male</td>
			</tr>
			<tr>
				<td>Farrah Fawcett</td>
				<td>Lady With Hair</td>
				<td>60</td>
				<td>Female</td>
			</tr>
			<tr>
				<td colspan="2">Johnny Boy Soprano</td>
				<td>90</td>
				<td>Male</td>								
			</tr>
		</tbody>		
	</table>


	<div id='testing'><a href="">Testing Text.</a></div>

	<a href="#" onclick="export_csv(this, 'test.csv', ['export1', 'export2', 'span_testing'])">Testing Button</a>
	
<script>
	
	function export_csv(a, filename, tables) {

		function parse_string_for_csv(input_string) {
			
			// if there are double-quotes or commas in the string
			// we need to escape the quotes and surround the whole thing with quotes
					
			// there might be a slicker way to do this using RegEx, but we'll
			// save that for later, if this proves to be too slow:				
					
			output_string = input_string.replace(/"/g, "\"\"");			// escape quotes
			
			if (input_string.search("[\",]") != -1) {					// enclose in quotes
				output_string = "\"" + output_string + "\""	
			}		
			output_string = output_string;						// always add the trailing comma
	
			console.debug("Input string: " + input_string);
			console.debug("Output string: " + output_string);
	
			return output_string;				
		}		

		var csvString = '';						// this will store our CSV	
				
		var cellArray = [];
				
		var currentRowIndex = 0;
		var maxColumnCount = 0;
		
		tables.forEach(function(table_name) {

			//$("#" + table_name).each( function() {		
			$("#" + table_name).each(function() {		
				
				$(this).find("tr").each(function() {
	
					var columnCount = 0;		// should check current row instead, to deal with rowspawn

					var currentRow = [];

					if(currentRowIndex < cellArray.length) {
						
						currentRow = cellArray[currentRowIndex];					
					}
					else {
						
						currentRow = []
						cellArray.push(currentRow);
					}

					$(this).find("th, td").each(function() {
						currentRow.push(parse_string_for_csv(this.textContent));

						colspan = parseInt($(this).attr("colspan")) || 1;
						rowspan = parseInt($(this).attr("rowspan")) || 1;
						
						columnCount += colspan;
						
						if (rowspan > 1 || colspan > 1) {
								
							var missingRows = currentRowIndex + rowspan - cellArray.length;
							
							for(; missingRows > 0; missingRows--) {							
								cellArray.push([]);
							}
							
							for(var spanRowIndex = currentRowIndex; spanRowIndex < currentRowIndex + rowspan; spanRowIndex++) {

								var missingColumns = spanRowIndex == currentRowIndex ? colspan - 1 : colspan;
								
								for (; missingColumns > 0; missingColumns--) {															
									cellArray[spanRowIndex].push('');
								}							
							}
						}					
					});
		
					if (columnCount > maxColumnCount) maxColumnCount = columnCount;
					
					currentRowIndex++;
				});								
				cellArray.push([]);
				currentRowIndex++;			
			});			
		});

		cellArray.pop();		// get rid of the last row, which is blank because of spacing between sub-tables.

		cellArray.forEach(function(currentRow) {

			csvString += currentRow.join();

			// some gross stuff to make sure that there are the same number of commas on each row
			// we need to add 1 comma less on empty rows, for reasons that are probably expressible mathemtically, but really annoying to do so.
			for (var missingColumns = maxColumnCount - (currentRow.length || 1); missingColumns > 0; missingColumns--) {				
				csvString += ',';			// fill out the rest of the row
			}
			
			csvString += '\r\n';
		});		

		var aFileParts = [csvString];
		
		// turn it into a blob in local storage:
		var oMyBlob = new Blob(aFileParts, {type : 'text/csv'}); // the blob
		
		var url = URL.createObjectURL(oMyBlob);		// get the URL to the blob
		
		// creates the temporary link that will send us to our generated CSV
		// don't use visible: False or hidden: True, or the click event won't work
		$(a).attr({
			text: 'A',
    		title: '',
    		href: url,
    		download: filename,
    		onclick: null
		})
	}
		
</script>
</body>
</html>
