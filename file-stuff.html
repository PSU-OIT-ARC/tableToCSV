<html>
<head>
	<title>
		File Stuff
	</title>
	
	
	<script src="jquery-1.11.1.js"></script>	
	
	<table class='export1' filename='export.csv'>
		<thead>
			<tr>
				<th>Name:</th>
				<th>Occupation:</th>
				<th>Age:</th>			
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>Bond, James</td>
				<td>Alcoholic</td>
				<td>37</td>
			</tr>
			<tr>
				<td>David "Zeb" Cook</td>
				<td>Dungeon Master</td>
				<td>97</td>
			</tr>
			<tr>
				<td>Mr. Potato Head, Esquire</td>
				<td>"Comedian"</td>
				<td>3</td>
			</tr>
			<tr>
				<td>John Carmack</td>
				<td>Nerd</td>
				<td>45</td>
			</tr>
		</tbody>		
	</table>

	<table>
	  <colgroup span="1" style="background-color: #ff0000;"></colgroup>
	  <colgroup span="2" style="background-color: #00ff00;"></colgroup>
	  <tr>
	    <td>1</td>
	    <td>2</td>
	    <td>3</td>
	  </tr>
	  <tr>
	    <td>4</td>
	    <td>5</td>
	    <td>6</td>
	  </tr>  
	</table>

	<div id='testing'><a href="">Testing Text.</a></div>

	<a href="" onclick="export_csv('test.csv', 'export1')">Testing Button</a>
	
</head>
	
<body>	
<script>

	$( document ).ready(function() {
		
		
    console.log( "ready!" );
	});

	



	function parse_string_for_csv(input_string) {
		
		// if there are double-quotes or commas in the string
		// we need to escape the quotes and surround the whole thing with quotes
				
		// there might be a slicker way to do this using RegEx, but we'll
		// save that for later, if this proves to be too slow:				
				
		output_string = input_string.replace(/"/g, "\"\"");			// escape quotes
		
		if (input_string.search("[\",]") != -1) {					// enclose in quotes
			output_string = "\"" + output_string + "\""	
		}
		
		output_string = output_string + ","						// always add the trailing comma

		console.debug("Input string: " + input_string);
		console.debug("Output string: " + output_string);

		return output_string;
				
	}		


	//	console.debug(parse_string_for_csv("\""));
	parse_string_for_csv("\"");
	parse_string_for_csv("Bond, James");
	parse_string_for_csv("David \"Zeb\" Cook");
	parse_string_for_csv('"Comedian"');


	var a;

	$(".export_table").each( function() {		
		
		var csvString = ''				
		var filename = $(this).attr('filename');
		
		$(this).find("tr").each(function() {
			
			$(this).find("th, td").each(function() {
				csvString += parse_string_for_csv(this.textContent);		// maybe put the commas in the CSV parser?								
			});

			// add together array, with commas in the middle and a new-line at the end

			csvString += '\r\n';
		});

		var aFileParts = [csvString];
		
		// turn it into a blob in local storage:
		var oMyBlob = new Blob(aFileParts, {type : 'text/csv'}); // the blob
		
		var url = URL.createObjectURL(oMyBlob);		// get the URL to the blob
		
		var b = $('<a>',{
			text: 'This is blah',
    		title: 'Blah',
    		href: url,
    		download: filename,
    		//click: function() { alert("Clicked!"); }
    		// click: function(){ BlahFunc( options.rowId );return false;}
		})
		
		b.appendTo('body');
		
		b[0].click();
		
		/*
		a = $('a');
		a.attr("href", url);		// set our link
		a.attr("download", filename);		// make it so the user gets a pretty filename rather than gibberish
		//a.css("display", "none");
		$('body').append(a);
		a.trigger('click');
		*/
		//win
				
	});
	
	
	function export_csv() {

		if (arguments.length < 2) return;		// ERROR!
		
		var filename = arguments[0]
		var csvString = ''						// this will store our CSV	
				
		for (var i = 1; i < arguments.length; i++) {

			class_name = arguments[i]
			
			$("." + class_name).each( function() {		
				
				$(this).find("tr").each(function() {
					
					$(this).find("th, td").each(function() {
						csvString += parse_string_for_csv(this.textContent);		// maybe put the commas in the CSV parser?								
					});
		
					// add together array, with commas in the middle and a new-line at the end		
					csvString += '\r\n';
				});
								
			});
			
		}

		var aFileParts = [csvString];
		
		// turn it into a blob in local storage:
		var oMyBlob = new Blob(aFileParts, {type : 'text/csv'}); // the blob
		
		var url = URL.createObjectURL(oMyBlob);		// get the URL to the blob
		
		// creates the temporary link that will send us to our generated CSV
		// don't use visible: False or hidden: True, or the click event won't work
		var temp_link = $('<a>',{
			text: '',
    		title: '',
    		href: url,
    		download: filename,			
		})
		
		temp_link.appendTo('body');

		temp_link[0].click();		// hack to mack the forced link-click work
	}
	
	
</script>


</body>
</html>
